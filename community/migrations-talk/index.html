<!doctype html>
<!-- ------------------------------------------------------------------------------ -->
<!-- ------------------------------------------------------------------------------ -->
<!-- ------------------------------------------------------------------------------ -->
<!-- Смотришь исходники? Пиши нам на team@bitrix.expert, нам есть о чём пообщаться! -->
<!-- ------------------------------------------------------------------------------ -->
<!-- ------------------------------------------------------------------------------ -->
<!-- ------------------------------------------------------------------------------ -->
<html lang="en-us">

<!-- Mirrored from bitrix.expert/community/migrations-talk/ by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 22 Aug 2016 19:57:27 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
    <!-- Basic Page Needs -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta charset="utf-8">
    <title>Беседа о миграциях - Битрикс-Эксперты bitrix.expert</title>
    <meta name="description" content="Эксперты 1С Битрикс">
    <meta name="keywords" content="статьи битрикс эксперты">

    <!-- Mobile Specific Metas-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="telephone=no" name="format-detection">

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="robots" content="index, follow" />
<link href="../../local/templates/inner/stylesa882.css?1457881419514012" type="text/css"  data-template-style="true"  rel="stylesheet" />
    <!-- Fonts -->
    <!-- Open Sans -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,600,700italic,400,700,800italic' rel='stylesheet' type='text/css'>
    <!-- VarelaRound -->
    <link href='http://fonts.googleapis.com/css?family=Varela+Round' rel='stylesheet' type='text/css'>
    <!-- Icon Font - Font Awesome -->
    <link href="../../local/templates/default/css/font-awesome.min.css" rel="stylesheet">

    <!-- Stylesheets -->
    <!-- External -->
    <!-- Mobile menu -->
    <link href="../../local/templates/default/css/z-nav.css" rel="stylesheet">

    <!-- Touch slider - Swiper -->
    <link href="../../local/templates/default/css/idangerous.swiper.css" rel="stylesheet" />
    <!-- Colorbox -->
    <link href="../../local/templates/default/css/colorbox.css" rel="stylesheet" />

    <!-- Custom -->
    <link href="../../local/templates/default/css/style.css" rel="stylesheet" />

    <!-- Basic JavaScript-->
    <!-- Modernizr -->
    <script src="../../local/templates/default/js/modernizr.custom.js"></script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/local/templates/default/js/html5shiv.js"></script>
    <script src="/local/templates/default/js/respond.js"></script>
    <![endif]-->
    <!-- jQuery 1.10.1-->
    <script src="../../../ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="external/jquery/jquery-1.10.1.min.html"><\/script>')</script>

    <!--[if lte IE 9]>
    <link href="/local/templates/default/css/ie9.css" rel="stylesheet" />
    <![endif]-->

    <link href="../../local/templates/default/css/custom.css" rel="stylesheet" />

    <style type="text/css">
        .person-wrap {
            display: block;
            position: relative;
        }
        .person-wrap:after {
            content: "";
            background: url();
            opacity: 0.2;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            position: absolute;
            z-index: -1;
            background-repeat: no-repeat;
            background-size: 100%;
            background-position-y: center;
        }
    </style>

</head>

<body>

<div class="wrapper" id="top">
    <!-- Header section -->
    <header class="header">
        <div class="header-fixed">
            <div class="header-line waypoint" data-animate-down="header-up" data-animate-up="header-down">
                <div class="container">
                    <!-- Contact information about company -->
                    <address class="contact-info pull-left hidden-lower">
						<span class="contact-info__item">
							<i class="fa fa-envelope"></i>
							team@bitrix.expert
						</span>
                    </address>
                    <!-- end contact information -->


                                    </div>  <!-- end container -->
            </div>

            <div class="fixed-top header-down">
                <div class="container">
                    <!--  Logo  -->
                    <a class="logo" href="../../index.html">
                        <!-- Remove comments to choose image and add comment to h1 -->
                        <!--<img src="images/logo-full.png" alt="">-->
                        <h1 class="logo__text" style="background-image: url(../../logo-white2.png);">Битрикс-<span class="highlight">Эксперты</span><br>
                            <span class="logo__slogan">Люди, технологии, идеи</span>
                        </h1>
                    </a>
                    <!-- End Logo -->

                    <!-- Navigation section -->
                    <nav class="z-nav">
                        <!-- Toggle for menu mobile view -->
                        <a href="#" class="z-nav__toggle">
                            <span class="menu-icon"></span>
                            <span class="menu-text">Навигация</span>
                            <div class="menu-head"></div>
                        </a>
                        
    <ul class="z-nav__list">
                            
                            <li class="z-nav__item current">
                <span class="z-nav__toggle-sub plus"><i class="fa fa-plus"></i><i class="fa fa-minus"></i></span>
                <a class="z-nav__link" href="../../index.html">Статьи</a>
                <ul class="z-nav__list-secondary">
                                            
                            <li class="z-nav__item ">
                    <a  class="z-nav__link" href="../../opensource/index.html">Opensource</a>
                </li>
                                            
                            <li class="z-nav__item ">
                    <a  class="z-nav__link" href="../../instrumenty/index.html">Инструменты</a>
                </li>
                                            
                            <li class="z-nav__item current">
                    <a  class="z-nav__link" href="../index.html">Сообщество</a>
                </li>
                                            
                            <li class="z-nav__item ">
                    <a  class="z-nav__link" href="../../standarty/index.html">Стандарты качества</a>
                </li>
                                            
                            <li class="z-nav__item ">
                    <a  class="z-nav__link" href="../../tekhnologii/index.html">Технологии производства</a>
                </li>
                                                            </ul></li>            

                                            
                            <li class="z-nav__item ">
                    <a  class="z-nav__link" href="http://meet.bitrix.expert">Общение с экспертами</a>
                </li>
                                            </ul>
    <!-- end list menu item -->

                    </nav>
                    <!-- end navigation section -->
                </div> <!-- end container -->

                <!-- Colored devider -->
                <div class="devider-color"></div>

            </div> <!-- end fixed top block -->

        </div>
    </header>
        <!-- end header section -->
    
    <section class="page-indecator">
        <div class="container">
            <h1 class="heading">Беседа о миграциях</h1>

            <ol class="breadcrumb"><li><a href="../../index.html" title="Статьи">Статьи</a></li><li><a href="../index.html" title="Сообщество">Сообщество</a></li></ol>
            <!-- Default one color devider -->
            <div class="devider devider--bottom-sm"></div>
        </div>
    </section>
    <!-- end section show current page and breadcrumb -->



<section class="container">
    <div class="post post--full">
        <!-- <h1 class="post-heading">Беседа о миграциях</h1> -->
        <br/>
                <div class="post--full__info">
            <p class="post__date post__date--rect">05 Янв 2016</p>
            <ul class="tags post__tags">
                                <li class="tags__item tags__item--user"><a href="../../experts/1/index.html" class="tags__link">
                        Цупко Игорь                    </a></li>
                                                <li class="tags__item"><a href="../../experts/1/index.html" class="tags__link">
                        Технический директор                    </a></li>
                            </ul>
        </div>

        <br/><br/><br/>

                    <b>Михаил Журов [6:17 PM]&nbsp;</b><br>
 Все мы знаем и понимаем всю необходимость и важность отделения кода приложения от базы данных.&nbsp;<br>
 Так если посудить, то много чего из битрикса не нужно разработчику, однако оно попадает к разработчику все равно по разным соображениям. Но что делать, если наша замечательная и любимая платформа обязывает нас поступать так, как мы поступаем? :simple_smile:<br>
 Поделитесь, как много у вас проектов, которые используют миграции для развертывания? Какие инструменты для создания миграций используете (кроме worksolutions/bitrix-module-migrations)? Каким образом осуществляется rollback (возможно ли при переходе по истории разработки в версионном контроле откатить и БД к нужной версии)? Каким образом выполняете наполнение БД тестовыми данными? С какими проблемами сталкивались при использовании миграций в битриксе? Даете ли вы в этом случае своим заказчикам доступ к настройкам дефолтных компонентов, где они сами без особого труда смогут поменять ID инфоблока, например?<br>
 Тема очень важная и щепетильная, у вас, видимо, есть опыт по решению этих проблем, и я был бы очень признателен, если бы вы поделились своим опытом на этом поприще.<br>
 <br>
 <b>Nik Samokhvalov [6:30 PM]&nbsp;</b><br>
 worksolutions/bitrix-module-migrations не использовал. Штука интересная, но предпочитаю более проверенные решения. Был проект с yii2-мигратором (мопед не мой, но работало прекрасно). А так, использую Phinx (<a href="http://samokhvalov.info/blog/all/phinx-multiple-databases/)">http://samokhvalov.info/blog/all/phinx-multiple-databases/)</a>. &nbsp;В популярных инструментах и интеграция с консольным приложением, и откаты, и просмотр истории. Всё включено :simple_smile:<br>
 <br>
 Контент может набиваться разными способами. Либо тупо дамп боевых табличек. Либо консольная команда, которая забьёт тестовыми данными ваши таблички. Есть даже fake-библиотеки для этого.<br>
 <br>
 Никаких проблем с использованием миграций не возникало.<br>
 &gt; Даете ли вы в этом случае своим заказчикам доступ к настройкам дефолтных компонентов, где они сами без особого труда смогут поменять ID инфоблока, например?<br>
 Я считаю, что это плохо, если клиент полезет менять айди инфоблока. Это изменение логики приложения, которое без ведома разработчиков производиться не должно. Но тем не менее, даже если такое произойдёт, ничего страшного не случится, если в настройки компонента будет сохраняться символьный код, а не идентификатор.(edited)<br>
 <br>
 &gt; Но что делать, если наша замечательная и любимая платформа обязывает нас поступать так, как мы поступаем?<br>
 @mikhail_zhurov: не поддавайтесь!<br>
 <br>
 <br>
 <b>Игорь Цупко [6:36]&nbsp;</b><br>
 &gt;С какими проблемами сталкивались при использовании миграций в битриксе?<br>
 <br>
 Основная проблема, связанная с миграциями в Битриксе - это отсутствие в Битриксе работы с консолью, как понятия.<br>
 Ибо миграции могут выполняться долго и даже очень долго. Запускать тяжёлые процессы с веб-интерфейса - это зло.<br>
 Но к счастью мы это победили и в скором времени презентуем миру наше решение в виде модуля.<br>
 <br>
 <b>Nik Samokhvalov [6:39 PM]&nbsp;</b><br>
 А, кстати. Из минусов Финкса: 1) в названия классов не подставляет таймстамп, поэтому приходится следить, что бы названия миграций были уникальными; 2) конфиги умеет читать только из yml-файлов.<br>
 <br>
 <b>Игорь Цупко [6:42 PM]&nbsp;</b><br>
 &gt;Каким образом осуществляется rollback (возможно ли при переходе по истории разработки в версионном контроле откатить и БД к нужной версии)?<br>
 <br>
 Одна из интереснейших вещей касательно rollback-а вскрывается на многосерверных конфигурациях. При корректной организации процесса rollback-и не так критичны (хотя я не говорю, что их не надо писать, отнюдь!)<br>
 <br>
 Смотрите:<br>
 У вас есть несколько нод. Пока вы обновляете одну ноду - остальные продолжают работать и отдавать клиенту контент. Задумайтесь: ваша база и код должны быть совместимы при переходе в рамках одной версии.<br>
 Если вам нужно переместить данные из одной таблицы в другую, вы не можете просто сделать alter table - ведь другие ноды всё ещё смотрят на старую таблицу.<br>
 <br>
 <b>Михаил Журов [6:53 PM]&nbsp;</b><br>
 @nik.samokhvalov: А как вообще выглядит расширение для Финкса? Судя по дефолтным примерам Финкс работает на уровне таблиц. Тогда я вижу 2 варианта - либо кодить миграции именно на уровне таблиц, возможно с помощью каких-то инструментов, которые возможно предоставляет Phinx. Либо каждая миграция это пара из 2х скриптов (функций/классов/методов, нужное подчеркнуть), один из которых, грубо говоря, создает инфоблок/группу пользователя/каталог через API битрикса, а другой - удаляет. Так? Может примерчик на gist? :simple_smile:<br>
 <br>
 Получается, что это и есть «те самые» скрипты миграции, которые использует битрикс при обновлениях, только с интерфейсом в виде консоли, а не веб-морды в админке, только разве что поддерживается переход в обе стороны, а не в одну.&nbsp;<br>
 В этом плане инструмент от WS выглядит несколько интереснее, поскольку может «записывать» действия по добавлению новых сущностей и воспроизводить их на другой платформе (но не знаю, сможет ли этот инструмент выполнит реверс)<br>
 <br>
 <b>Ivan Tsirulev [6:53 PM]&nbsp;</b><br>
 @may-cat Пример не совсем понятный. Имеется ввиду применение open/closed принципа в контексте модели данных? При миграции разрешено дополнять базу данных новым, но запрещено изменять существующее?(edited)<br>
 Если так, то подтверждаю — это единственный способ "выжить" в многосерверной среде.<br>
 И в этом случае нужды rollback практически нет. Любые изменения в базе будут совместимыми со старым кодом.<br>
 <br>
 <b>Nik Samokhvalov [6:56 PM]&nbsp;</b><br>
 &gt; один из которых, грубо говоря, создает инфоблок/группу пользователя/каталог через API битрикса, а другой - удаляет. Так?<br>
 Всё так. В одном классе описываются методы `up()` и `down()`. Разработчик должен сам прописать алгоритм создания инфоблока / группы пользователей / веб-формы / таблицы в БД. И откат.<br>
 &gt; Получается, что это и есть «те самые» скрипты миграции, которые использует битрикс при обновлениях, только с интерфейсом в виде консоли, а не веб-морды в админке, только разве что поддерживается переход в обе стороны, а не в одну.<br>
 Разве у Битрикса есть такой инструмент? Его «инструмент», на сколько мне известно — `updater.php`. Топорный ПХП-файл, который выполнится при накатывании обновления.<br>
 Никакой версионности, никакой истории, никаких откатов…<br>
 <br>
 <b>Михаил Журов [6:59 PM]&nbsp;</b><br>
 а я и не назвал это «инструментом» :simple_smile: я назвал их «скриптами миграции», которые рекомендует использовать команда разработки битрикса в своем курсе. Откатов - нет. История, скорее всего, есть, но у битриксоидов<br>
 <br>
 <b>Михаил Журов [7:09 PM]&nbsp;</b><br>
 А как вы поступаете, если на ваших тестовых данных проблема не моделируется, а моделируется только на данных с прод сервера? Скажем, ошибка появляется только у группы товаров, которые находятся на 5м уровне вложенности каталога только у тех товаров, которые имеют в своем названии какой-нибудь специальный символ (но понятно, что вы этих кейсов заранее не знаете). Каким образом осуществляется перенос нужных данных с прода на дев?<br>
 или же вы не переносите ничего, а пытаетесь воспроизвести проблему у себя любой ценой, даже если не получается этого выполнить в течение длительного времени?<br>
 <br>
 <b>Nik Samokhvalov [7:19 PM]&nbsp;</b><br>
 Как правило (по крайней мере, у меня так было), получается воспроизводятся на деве: смотришь, что есть на проблемной площадке и воссоздаёшь похожую ситуацию у себя. В противном случае, да, выкачиваем нужные таблички и моделируем окружение у себя. Но это редкость.<br>
 <br>
 <b>Ivan Tsirulev [7:21 PM]&nbsp;</b><br>
 Полагаю, у каждой команды свой подход. Опишу наш:<br>
 <br>
 - Обязательно используется сервер разработки, где, собственно, все и работают. Для приверженцев локальной разработки подойдет вариант использования сервера базы данных внутри сети, что позволит работать с файлами локально.<br>
 <br>
 - Каждая задача относится либо к поддержке (решение существующих ошибок), либо к разработке (расширение функциональности).<br>
 <br>
 - Все задачи разработки решаются на отдельной базе данных, которая клонируется на основе продуктивной в начале цикла разработки и не обновляется до ее завершения, за редким исключением.<br>
 <br>
 - Все задачи поддержки решаются на отдельной базе данных, которая не совпадает с базой данных для задач разработки (см. выше) и актуализируется продуктивными данными раз в день (иногда чаще). Под актуализацией понимается получение полной копии продуктивной базы данных.<br>
 <br>
 <b>Михаил Журов [7:22 PM]&nbsp;</b><br>
 @nik.samokhvalov: А много ли времени отнимает операция по воспроизведению данных с прода на деве в типичной ситуации (без переноса таблиц)<br>
 <br>
 <b>Ivan Tsirulev [7:22 PM]&nbsp;</b><br>
 При решении ошибок (задачи поддержки) надобности в сохранении данных изо дня в день нет. Потому полная переливка БД — допустимое и практичное решение.<br>
 <br>
 <b>Игорь Цупко [7:23 PM]&nbsp;</b><br>
 Добавлю также, что значительную часть проблем можно продиагностировать, не вмешиваясь в исходный код/данные, если иметь достаточный кругозор. Этим должны заниматься специально обученные люди. И заниматься они этим могут даже на боевой базе.<br>
 <br>
 <b>Nik Samokhvalov [7:25 PM]&nbsp;</b><br>
 Эм… Зависит от проблемы. Что-то можно воспроизвести на раз-два, что-то чуть дольше. Как верно заметил Игорь, иногда не обязательно даже запускать приложение, что бы обнаружить косяк, как бы грустно это не звучало :simple_smile:<br>
 <br>
 <b>Ivan Tsirulev [7:28 PM]</b>&nbsp;<br>
 И это подводит нас ко второй по значимости вещи при разработке — обязательному логгированию всего и вся. Наверное прозвучит экстремально, но я твердо верю, что проект можно считать поддерживаемым, только если совокупные размеры его логов превышают размер файлов и базы вместе взятых. И лучше в несколько раз.<br>
 <br>
 <b>Игорь Цупко [7:29 PM]&nbsp;</b><br>
 а также мониторингу всего и вся, что плохо и хорошо привинчено<br>
 вообще всего<br>
 если проблема возникла, а по результатам инцидента в мониторинге или тестах не появилось проверки - с высокой вероятность что-то организовано не так.(edited)<br>
 <br>
 <b>Ivan Tsirulev [7:31 PM]&nbsp;</b><br>
 Именно. Из опыта, результатом решения где-то половины ошибок становится не только непосредственное решение, но и появление нового мониторинга.<br>
 <br>
 <b>Михаил Журов [7:41 PM]&nbsp;</b><br>
 @ivan.tsirulev Иван. А вы тестовую базу обновляете с прода в автоматическом режиме? Какими инструментами пользуетесь для регулярного обновления?<br>
 <br>
 <b>Ivan Tsirulev [7:43 PM]&nbsp;</b><br>
 На простых проектах — простыми bash скриптами, которые забирают свежую резервную копию "оттуда" и разворачивают ее "здесь". На непростых проектах — лютыми самописными bash скриптами и нестандартными топологическими решениями. Непростые проекты — это где размер базы от 500 Гб и более.<br>
 <br>
 <b>Ivan Tsirulev [7:46 PM]&nbsp;</b><br>
 Предвосхищая возможный вопрос: развертывание четырех копий БД размером в 500 Гб в среде разработки занимает от 3 часов &nbsp;до 3 часов 20 минут, в зависимости от погоды. Время развертывания зависит от размера линейно. Процесс происходит ночью.<br>
 <br>        
    </div><!-- end post -->

    
    <div>
        <h2 class="block-title" id="comment-start">Комментарии</h2>

        <div id="hypercomments_widget"></div>
        <script type="text/javascript">
            _hcwp = window._hcwp || [];
            _hcwp.push({widget:"Stream", widget_id: 24804});
            (function() {
                if("HC_LOAD_INIT" in window)return;
                HC_LOAD_INIT = true;
                var lang = (navigator.language || navigator.systemLanguage || navigator.userLanguage || "en").substr(0, 2).toLowerCase();
                var hcc = document.createElement("script"); hcc.type = "text/javascript"; hcc.async = true;
                hcc.src = ("https:" == document.location.protocol ? "https" : "http")+"://w.hypercomments.com/widget/hc/24804/"+lang+"/widget.js";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hcc, s.nextSibling);
            })();
        </script>
        <a href="http://hypercomments.com/" class="hc-link" title="comments widget">comments powered by HyperComments</a>

    </div>
    <!-- end comment area -->
</section>

    <!-- Colored devider -->
<div class="devider-color bottom-space"></div>

<!-- Footer section -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <!-- Contact info about company -->
            <div class="col-sm-8">
                <h3 class="heading-info heading-info--mobile">Контакты:</h3>
                <!-- Contact information about company -->
                <address class="contact-info contact-info--list">
                    <div class="row">
                        <div class="col-xs-6 col-sm-12 one-column">
									<span class="contact-info__item">
										<i class="fa fa-mobile"></i>
										+7-926-827-37-83
									</span>
                        </div>

                        <div class="col-xs-6 col-sm-12 one-column">
									<span class="contact-info__item">
										<i class="fa fa-envelope"></i>
										team@bitrix.expert
									</span>
									<span class="contact-info__item">
										<i class="fa fa-skype"></i>
										may_cat_ghost
									</span>
                        </div>
                    </div>
                </address>
                <!-- end contact information -->
            </div>
            <!-- end contact info -->

            <!-- Social links -->
            <div class="col-sm-4">
                <h3 class="heading-info heading-info--mobile">Другие площадки:</h3>
                <div class="social social--default">
                    <!-- List with social icons -->
                    <ul>
                        <li class="social__item"><a class="social__link" href="https://github.com/bitrix-expert" target="_blank"><i class="social__icon fa fa-github-alt"></i></a></li>
                    </ul>
                </div>
            </div>
            <!-- end social links -->
        </div><!-- end row -->
    </div><!-- end container -->
</footer>
<!-- end footer section -->

<div class="top-scroll"><i class="fa fa-angle-up"></i></div>

</div>

<!-- JavaScript-->
<!-- External-->
<!-- Bootstrap 3-->
<script src="../../local/templates/default/js/bootstrap.min.js"></script>
<!-- Mobile menu -->
<script src="../../local/templates/default/js/jquery.mobile.menu.js"></script>
<!-- Touch slider - Swiper -->
<script src="../../local/templates/default/js/idangerous.swiper.js"></script>
<!-- Scroll to piugin -->
<script src="../../local/templates/default/js/jquery.scrollTo.min.js"></script>
<!-- Flickr -->
<script src="../../local/templates/default/js/jflickrfeed.js"></script>
<!-- Colorbox -->
<script src="../../local/templates/default/js/jquery.colorbox.js"></script>

<!-- Custom -->
<script src="../../local/templates/default/js/custom.js"></script>
<!-- Yandex.Metrika counter --><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter28974510 = new Ya.Metrika({id:28974510, webvisor:true, clickmap:true, trackLinks:true, accurateTrackBounce:true}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="http://mc.yandex.ru/watch/28974510" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter -->
</body>

<!-- Mirrored from bitrix.expert/community/migrations-talk/ by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 22 Aug 2016 19:57:27 GMT -->
</html>
